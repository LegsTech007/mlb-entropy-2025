<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MLB 2025 — Outcome Entropy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2/css/dataTables.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2/js/dataTables.min.js"></script>

  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin-bottom: 4px; }
    .muted { color:#666; margin-top:0; }
    .grid { display:grid; gap:32px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    table.dataTable { width:100% !important; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; margin-left:6px; font-size:12px; }
    .downloads a { margin-right:12px; }
  </style>
</head>
<body>
  <header>
    <h1>MLB 2025 — Outcome Entropy</h1>
    <p class="muted">Diversity of plate appearance outcomes by player and team (higher = more varied outcomes).</p>
    <div class="downloads">
      <strong>Download CSVs:</strong>
      <a href="entropy_players.csv" download>Players</a>
      <a href="entropy_teams.csv" download>Teams</a>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Players <span id="players-count" class="badge"></span></h2>
      <table id="players" class="display"></table>
    </div>

    <div class="card">
      <h2>Teams <span id="teams-count" class="badge"></span></h2>
      <table id="teams" class="display"></table>
    </div>

    <div class="card">
      <h2>Summary</h2>
      <div id="summary"></div>
    </div>
  </section>

  <script>
    // ---- CSV loader with cache-buster ----
    function loadCSV(url) {
      const busted = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      return new Promise((resolve, reject) => {
        Papa.parse(busted, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: r => resolve(r.data || []),
          error: err => reject(err)
        });
      });
    }

    // ---- DataTable with column-widths based on longest value ----
    function renderTable(id, data, columns) {
      const table = $('#' + id).DataTable({
        data,
        columns,
        pageLength: 25,
        deferRender: true,
        order: [],
        autoWidth: false
      });

      function applyColumnWidths() {
        table.columns().every(function() {
          const headerText = String($(this.header()).text() || '');
          const colData = this.data().toArray().map(v => v == null ? '' : String(v));
          const maxLen = Math.max(headerText.length, ...colData.map(s => s.length));
          $(this.header()).css('width', (maxLen + 2) + 'ch'); // +2ch padding
        });
      }

      table.on('draw', applyColumnWidths);
      applyColumnWidths();
    }

    function fmt(n, d=3){ return (n==null || isNaN(n)) ? "" : Number(n).toFixed(d); }

    // ---- Transform teams CSV per your rules ----
    // remove: team_abbrev, qualified_players
    // replace: team_name -> team (fallback: team_abbrev -> team_id)
    // remove underscores from ALL rendered column names
    function transformTeams(rows) {
      return rows.map(r => {
        const teamVal = r.team ?? r.team_name ?? r.team_abbrev ?? r.team_id ?? "";
        const out = { team: teamVal };

        for (const [k, v] of Object.entries(r)) {
          if (k === 'team_abbrev' || k === 'qualified_players' || k === 'team_name') continue;
          if (k === 'team') continue; // already handled above
          // Convert header: underscores -> spaces
          const prettyKey = k.replace(/_/g, ' ');
          out[prettyKey] = v;
        }
        return out;
      });
    }

    async function main() {
      // ---- Players (requires: player, team, PA, AB, entropy) ----
      const players = await loadCSV('entropy_players.csv').catch(() => []);
      if (players.length) {
        document.getElementById('players-count').textContent = players.length + " qualified";
        renderTable('players', players, [
          { title:'player',  data:'player' },
          { title:'team',    data:'team' },
          { title:'PA',      data:'PA' },
          { title:'AB',      data:'AB' },
          { title:'entropy', data:'entropy', render:(d)=>fmt(d) }
        ]);

        // Summary
        const sorted = [...players].sort((a,b) => (b.entropy ?? -1) - (a.entropy ?? -1));
        const top = sorted.slice(0,5), bot = sorted.slice(-5).reverse();
        const li = x => `<li>${x.player} (${x.team}) — ${fmt(x.entropy)}</li>`;
        document.getElementById('summary').innerHTML = `
          <p><strong>Qualified players:</strong> ${players.length}</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div><h3 style="margin-top:0;">Top 5 Entropy</h3><ol>${top.map(li).join('')}</ol></div>
            <div><h3 style="margin-top:0;">Bottom 5 Entropy</h3><ol>${bot.map(li).join('')}</ol></div>
          </div>`;
      } else {
        document.getElementById('players-count').textContent = "0";
      }

      // ---- Teams (optional; render only if file present & non-empty) ----
      let teams = [];
      try { teams = await loadCSV('entropy_teams.csv'); } catch {}
      if (teams.length) {
        // Transform per your rules
        const teamsT = transformTeams(teams);

        // Build columns from transformed keys
        const keys = Object.keys(teamsT[0]);
        const columns = keys.map(k => ({
          title: k,          // already has spaces (no underscores)
          data: k,
          render: (val) => {
            // format numbers for entropy-like columns
            if (typeof val === 'number' && /entropy/i.test(k)) return fmt(val);
            return val;
          }
        }));

        // Count teams based on "team" field after transform
        const teamCount = new Set(teamsT.map(t => t.team).filter(Boolean)).size || teamsT.length;
        document.getElementById('teams-count').textContent = teamCount + " teams";

        renderTable('teams', teamsT, columns);
      } else {
        document.getElementById('teams-count').textContent = "—";
      }
    }

    main();
  </script>
</body>
</html>
